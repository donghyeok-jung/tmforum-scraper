name: tmforum daily scrape (latest only + Teams DM card on change)

on:
  schedule:
    - cron: "0 23 * * *"   # 매일 08:00 KST (UTC 23:00)
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: "requirements.txt"

      - name: Install deps
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Playwright browsers
        run: python -m playwright install --with-deps chromium

      - name: Run scraper
        id: scrape
        run: python scraper/scrape_tmforum.py

      - name: Show outputs
        run: |
          echo "changed=${{ steps.scrape.outputs.changed }}"
          echo "ts_kst=${{ steps.scrape.outputs.ts_kst }}"
          echo "summary=${{ steps.scrape.outputs.summary }}"

      - name: Notify me on Teams DM (only when changed, adaptive card)
        if: steps.scrape.outputs.changed == 'true'
        env:
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
          TS_KST: ${{ steps.scrape.outputs.ts_kst }}
          SUMMARY: ${{ steps.scrape.outputs.summary }}
        run: |
          python - <<'PY'
          import os, json, urllib.request

          url = os.environ["TEAMS_WEBHOOK_URL"]
          ts = os.environ.get("TS_KST", "")
          summary = os.environ.get("SUMMARY", "")

          # summary는 "col1 | col2 | col3 | col4 | col5 | col6" 형태.
          # col1이 비어있으면 nan이 들어올 수 있으니 col2~col6만 보여주도록 정리.
          parts = [p.strip() for p in summary.split("|")]
          if len(parts) >= 6:
            item_line = " | ".join(parts[1:6])  # col2~col6
          else:
            item_line = summary

          link = "https://www.tmforum.org/topics/an-resources/"

          payload = {
            "type": "message",
            "attachments": [
              {
                "contentType": "application/vnd.microsoft.card.adaptive",
                "contentUrl": None,
                "content": {
                  "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                  "type": "AdaptiveCard",
                  "version": "1.5",
                  "body": [
                    {
                      "type": "TextBlock",
                      "size": "Medium",
                      "weight": "Bolder",
                      "text": "TM Forum Validation 표에 신규 목록이 추가되었습니다.",
                      "wrap": True
                    },
                    {
                      "type": "TextBlock",
                      "text": link,
                      "wrap": True,
                      "color": "Accent"
                    },
                    {
                      "type": "TextBlock",
                      "text": item_line,
                      "wrap": True
                    },
                    {
                      "type": "TextBlock",
                      "text": f"(KST) {ts}",
                      "isSubtle": True,
                      "wrap": True
                    }
                  ]
                }
              }
            ]
          }

          req = urllib.request.Request(
            url,
            data=json.dumps(payload).encode("utf-8"),
            headers={"Content-Type": "application/json"},
            method="POST",
          )

          with urllib.request.urlopen(req, timeout=30) as resp:
            print("Teams webhook status:", resp.status)
          PY

      - name: Commit & push (latest csv)
        run: |
          ls -al data || true
          test -f data/tmforum_an_validations_latest.csv && echo "CSV exists" || (echo "CSV missing" && exit 1)

          git add -A
          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "chore: update latest scrape"
          git push
